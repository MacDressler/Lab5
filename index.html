<!DOCTYPE html>
<html>
<head>
    <title>GeoWeb Application</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.2.0/paho-mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
</head>
<body>
    <div id="map" style="height: 400px;"></div>
    <button id="start">Start</button>
    <button id="end" disabled>End</button>
    <button id="share">Share My Status</button>

    <script>
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var marker = L.marker([0, 0]).addTo(map);

        // Function to update marker color based on temperature
        function updateMarkerColor(temperature) {
            if (temperature < -40)
                return 'blue';
            else if (temperature < 10)
                return 'green';
            else
                return 'red';
        }

        // Function to subscribe to MQTT topic for temperature updates
        function subscribeToTemperature() {
            var client = new Paho.MQTT.Client("mqtt.eclipse.org", Number(1883), "clientId", mqtt.MQTTv311);

            client.onConnectionLost = function (responseObject) {
                console.log("Connection lost: " + responseObject.errorMessage);
                setTimeout(function () { client.connect() }, 5000);
            };

            client.onMessageArrived = function (message) {
                var payload = JSON.parse(message.payloadString);
                var temperature = payload.properties.temperature;
                marker.setPopupContent("Temperature: " + temperature.toFixed(2) + "Â°C").openPopup();
                marker.setIcon(new L.Icon({
                    iconUrl: 'http://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + updateMarkerColor(temperature) + '.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    tooltipAnchor: [16, -28],
                    shadowSize: [41, 41]
                }));
            };

            client.connect({
                onSuccess: function () {
                    client.subscribe("CS101/John_Doe/my_temperature");
                },
                onFailure: function (message) {
                    console.log("Connection failed: " + message.errorMessage);
                }
            });
        }

        // Start button click event
        $("#start").click(function () {
            $("#start").prop("disabled", true);
            $("#end").prop("disabled", false);
            subscribeToTemperature();
        });

        // End button click event
        $("#end").click(function () {
            $("#start").prop("disabled", false);
            $("#end").prop("disabled", true);
        });

        // Share button click event
        $("#share").click(function () {
            var geojson = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [0, 0]
                },
                "properties": {
                    "temperature": Math.floor(Math.random() * (60 - (-40) + 1)) + (-40)
                }
            };

            var message = new Paho.MQTT.Message(JSON.stringify(geojson));
            message.destinationName = "CS101/John_Doe/my_temperature";
            var client = new Paho.MQTT.Client("mqtt.eclipse.org", Number(1883), "clientId");
            client.connect({ onSuccess: function () { client.send(message); } });
        });
    </script>
</body>
</html>
